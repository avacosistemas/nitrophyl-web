<div>
    <form [formGroup]="piezaForm" (ngSubmit)="guardarPieza()" class="mat-form-without-wrapper flex flex-col gap-4">

        <!-- Sección Pieza -->
        <div class="flex gap-4 grid grid-cols-2">
            <div class="flex flex-col gap-4 h-fit border-2 bg-white border-gray-200 rounded-2xl p-4"
                *ngIf="mode === 'create' || mode === 'edit' || mode === 'view'">
                <span class="text-xl md:text-xl font-extrabold tracking-tight leading-7 sm:leading-10 truncate">
                    Pieza
                </span>
                <div class="flex flex-col gap-1">
                    <mat-form-field appearance="outline" class="form-field w-full">
                        <mat-label>Nombre de la Pieza</mat-label>
                        <input type="text" matInput formControlName="nombre" required [matAutocomplete]="autoNombre"
                            [readonly]="mode !== 'edit' && mode !== 'create'"
                            [value]="piezaForm.get('nombre').value?.nombre || piezaForm.get('nombre').value">
                        <mat-autocomplete #autoNombre="matAutocomplete" [displayWith]="displayPieceName.bind(this)">
                            <mat-option *ngFor="let pieceName of filteredPieceNames$ | async" [value]="pieceName">
                                {{ pieceName.nombre }}
                            </mat-option>
                        </mat-autocomplete>
                        <mat-error *ngIf="piezaForm.get('nombre').hasError('required')">El nombre es
                            requerido</mat-error>
                    </mat-form-field>

                    <mat-form-field appearance="outline" class="form-field w-full ">
                        <mat-label>Tipo</mat-label>
                        <input type="text" matInput placeholder="Tipo" #tipoInput formControlName="tipo"
                            [matAutocomplete]="autoTipo" [readonly]="mode !== 'edit' && mode !== 'create'"
                            [value]="piezaForm.get('tipo').value">
                        <button mat-icon-button matSuffix
                            *ngIf="(piezaForm.get('tipo')?.value && mode !== 'edit') && mode !== 'view'"
                            (click)="clearTipoInput(); $event.stopPropagation()">
                            <mat-icon>close</mat-icon>
                        </button>
                        <mat-autocomplete #autoTipo="matAutocomplete" [displayWith]="displayFn">
                            <mat-option *ngFor="let tipo of tiposPieza$ | async" [value]="tipo">
                                {{ tipo }}
                            </mat-option>
                        </mat-autocomplete>
                    </mat-form-field>

                    <mat-form-field appearance="outline" class="form-field w-full ">
                        <mat-label>Molde</mat-label>
                        <input type="text" matInput formControlName="moldeId" required #moldeInput
                            [matAutocomplete]="autoMolde" [readonly]="mode !== 'edit' && mode !== 'create'"
                            [value]="piezaForm.get('moldeId').value?.nombre || piezaForm.get('moldeId').value">
                        <button mat-icon-button matSuffix
                            *ngIf="(piezaForm.get('moldeId')?.value && mode !== 'edit') && mode !== 'view'"
                            (click)="clearMoldeInput(); $event.stopPropagation()">
                            <mat-icon>close</mat-icon>
                        </button>
                        <mat-autocomplete #autoMolde="matAutocomplete" [displayWith]="displayMolde">
                            <mat-option *ngFor="let molde of filteredMoldes$ | async" [value]="molde">
                                {{ molde.nombre }}
                            </mat-option>
                        </mat-autocomplete>
                        <mat-error *ngIf="piezaForm.get('moldeId').hasError('required')">El molde es
                            requerido</mat-error>
                    </mat-form-field>
                </div>
            </div>

            <!-- Sección Cliente (Creación) -->
            <div class="flex flex-col gap-4 h-fit border-2 bg-white border-gray-200 rounded-2xl p-4"
                *ngIf="mode === 'create'">
                <span class="text-xl md:text-xl font-extrabold tracking-tight leading-7 sm:leading-10 truncate">
                    Cliente
                </span>
                <div class="flex flex-col gap-1">
                    <mat-form-field appearance="outline" class="form-field w-full ">
                        <mat-label>Cliente</mat-label>
                        <input type="text" matInput formControlName="clienteId" required #clienteInput
                            [matAutocomplete]="autoCliente" [readonly]="mode !== 'edit' && mode !== 'create'"
                            [value]="piezaForm.get('clienteId').value?.nombre || piezaForm.get('clienteId').value">
                        <button mat-icon-button matSuffix
                            *ngIf="(piezaForm.get('clienteId')?.value && mode !== 'edit') && mode !== 'view'"
                            (click)="clearClienteInput(); $event.stopPropagation()">
                            <mat-icon>close</mat-icon>
                        </button>
                        <mat-autocomplete #autoCliente="matAutocomplete" [displayWith]="displayCliente">
                            <mat-option *ngFor="let cliente of filteredClientes$ | async" [value]="cliente">
                                {{ cliente.nombre }}
                            </mat-option>
                        </mat-autocomplete>
                        <mat-error *ngIf="piezaForm.get('clienteId').hasError('required')">El cliente es
                            requerido</mat-error>
                    </mat-form-field>

                    <mat-form-field appearance="outline" class="form-field w-full ">
                        <mat-label>Nombre Pieza Personalizado</mat-label>
                        <input matInput formControlName="nombrePiezaPersonalizado"
                            [readonly]="mode !== 'edit' && mode !== 'create'">
                    </mat-form-field>
                </div>
            </div>

            <!-- Sección Fórmula -->
            <div class="flex flex-col gap-4 h-fit border-2 bg-white border-gray-200 rounded-2xl p-4"
                *ngIf="mode === 'create' || mode === 'edit' || mode === 'view'">
                <span class="text-xl md:text-xl font-extrabold tracking-tight leading-7 sm:leading-10 truncate">
                    Fórmula
                </span>
                <div class="flex flex-col gap-1">
                    <div class="flex gap-4">
                        <mat-form-field appearance="outline" class="form-field w-full ">
                            <mat-label>Fórmula</mat-label>
                            <input type="text" matInput formControlName="formula" required
                                [readonly]="mode !== 'edit' && mode !== 'create'" #formulaInput
                                [matAutocomplete]="autoFormula" [displayWith]="displayFormula">
                            <button mat-icon-button matSuffix
                                *ngIf="(piezaForm.get('formula')?.value && mode !== 'edit') && mode !== 'view'"
                                (click)="clearFormulaInput(); $event.stopPropagation()">
                                <mat-icon>close</mat-icon>
                            </button>
                            <mat-autocomplete #autoFormula="matAutocomplete" [displayWith]="displayFormula">
                                <mat-option *ngFor="let formula of filteredFormulas$ | async" [value]="formula">
                                    {{ formula.nombre }}
                                </mat-option>
                            </mat-autocomplete>
                            <mat-error *ngIf="piezaForm.get('formula').hasError('required')">La fórmula es
                                requerida</mat-error>
                        </mat-form-field>

                        <mat-form-field appearance="outline" class="form-field w-full ">
                            <mat-label>Dureza</mat-label>
                            <input matInput type="number" formControlName="dureza" required
                                [readonly]="mode !== 'edit' && mode !== 'create'">
                            <mat-error *ngIf="piezaForm.get('dureza').hasError('required')">La dureza es
                                requerida</mat-error>
                            <mat-error *ngIf="piezaForm.get('dureza')?.hasError('pattern')">
                                Debe ser un número entero.
                            </mat-error>
                        </mat-form-field>
                    </div>

                    <div class="flex gap-4">
                        <mat-form-field appearance="outline" class="form-field w-full">
                            <mat-label>Espesor Plancha Mínimo (mm)</mat-label>
                            <input matInput type="number" formControlName="espesorPlanchaMin"
                                [readonly]="mode !== 'edit' && mode !== 'create'">
                        </mat-form-field>

                        <mat-form-field appearance="outline" class="form-field w-full">
                            <mat-label>Espesor Plancha Máximo (mm)</mat-label>
                            <input matInput type="number" formControlName="espesorPlanchaMax"
                                [readonly]="mode !== 'edit' && mode !== 'create'">
                        </mat-form-field>
                    </div>

                    <div class="flex gap-4">
                        <mat-form-field appearance="outline" class="form-field w-full ">
                            <mat-label>Peso Crudo (gramos)</mat-label>
                            <input matInput type="number" formControlName="pesoCrudo"
                                [readonly]="mode !== 'edit' && mode !== 'create'">
                        </mat-form-field>

                        <mat-form-field appearance="outline" class="form-field w-full ">
                            <mat-label>Observaciones Peso Crudo</mat-label>
                            <input matInput formControlName="observacionesPesoCrudo"
                                [readonly]="mode !== 'edit' && mode !== 'create'">
                        </mat-form-field>
                    </div>
                </div>
            </div>

            <!-- Sección Plano (Creación) - Incluyendo el formulario de subida -->
            <div class="flex flex-col gap-4 h-fit border-2 bg-white border-gray-200 rounded-2xl p-4"
                *ngIf="mode === 'create'">
                <span class="text-xl md:text-xl font-extrabold tracking-tight leading-7 sm:leading-10 truncate">
                    Plano
                </span>
                <div class="flex flex-col gap-1">
                    <label for="file-upload" class="cursor-pointer mb-4 relative" *ngIf="mode === 'create'">
                        <div
                            class="flex flex-col items-center justify-center p-4 border-2 border-dashed border-gray-400 rounded-lg bg-gray-50">
                            <div class="flex flex-col items-center justify-center">
                                <mat-icon class="text-gray-500" svgIcon="heroicons_solid:upload" *ngIf="!selectedFile"
                                    style="font-size: 2rem;"></mat-icon>
                                <span class="text-sm text-gray-600" *ngIf="!selectedFile">Seleccionar Plano</span>
                                <span class="text-sm text-green-500" *ngIf="selectedFile">{{ selectedFile?.name
                                    }}</span>
                            </div>
                            <input id="file-upload" type="file" class="sr-only" (change)="onFileSelected($event)"
                                accept="pdf">
                        </div>

                        <button *ngIf="selectedFile" type="button" mat-icon-button class="absolute top-2 right-2"
                            (click)="removeSelectedFile()">
                            <mat-icon>cancel</mat-icon>
                        </button>
                    </label>

                    <div class="flex gap-4">
                        <mat-form-field appearance="outline" class="w-1/2">
                            <mat-label>Código</mat-label>
                            <input matInput formControlName="codigo" required
                                [readonly]="mode !== 'edit' && mode !== 'create'">
                        </mat-form-field>

                        <mat-form-field appearance="outline" class="w-1/2">
                            <mat-label>Revisión</mat-label>
                            <input matInput type="number" formControlName="revisionPlano" required
                                [readonly]="mode !== 'edit' && mode !== 'create'">
                            <mat-error *ngIf="planoForm.get('revisionPlano')?.hasError('pattern')">
                                Debe ser un número entero.
                            </mat-error>
                        </mat-form-field>
                    </div>
                    <mat-form-field appearance="outline">
                        <mat-label>Clasificación</mat-label>
                        <mat-select formControlName="clasificacion" required
                            [disabled]="mode !== 'edit' && mode !== 'create'">
                            <mat-option *ngFor="let option of clasificacionOptions" [value]="option.value">
                                {{ option.label }}
                            </mat-option>
                        </mat-select>
                    </mat-form-field>
                    <mat-form-field appearance="outline">
                        <mat-label>Observaciones</mat-label>
                        <textarea matInput formControlName="descripcion" rows="4"
                            [readonly]="mode !== 'edit' && mode !== 'create'"></textarea>
                    </mat-form-field>
                </div>
            </div>
        </div>

        <!-- Sección Revision (Edición) -->
        <div class="flex gap-4 w-full">
            <div class="flex flex-col gap-4 h-fit border-2 bg-white border-gray-200 rounded-2xl p-4 w-1/3"
                *ngIf="mode === 'edit' || mode === 'view'">
                <span class="text-xl md:text-xl font-extrabold tracking-tight leading-7 sm:leading-10 truncate">
                    Revisión
                </span>
                <fuse-card class="flex flex-col px-8 pb-4" #fuseCard>
                    <div class="justify-between h-full items-center"
                        [ngClass]="(pieza?.revision !== null && pieza?.revision >= '0') ? 'flex_col' : 'flex'">
                        <div *ngIf="pieza?.revision !== null && pieza?.revision >= '0'"
                            class="mt-2 flex flex-col items-center">
                            <div class="text-7xl font-bold leading-none tracking-tight text-blue-500 sm:text-8xl">
                                {{ pieza?.revision }}
                            </div>
                            <div class="text-secondary mt-1 flex w-full items-baseline justify-center">
                                <div class="ml-1.5 text-lg font-semibold flex items-center gap-2">
                                    <mat-icon [svgIcon]="'heroicons_solid:calendar'"></mat-icon>
                                    <p>{{ pieza?.fechaRevision | date: 'dd/MM/yyyy' }}</p>
                                </div>
                            </div>
                        </div>
                        <div class="mt-2 flex justify-center w-full" *ngIf="mode === 'edit'">
                            <button mat-flat-button
                                class="mat-focus-indicator mat-flat-button mat-button-base mat-accent"
                                (click)="generarNuevaRevision()">
                                <span class="mat-button-wrapper">Generar Nueva Revisión</span>
                                <span matripple="" class="mat-ripple mat-button-ripple"></span>

                            </button>
                        </div>
                    </div>
                </fuse-card>
            </div>

            <!-- Sección Observaciones de la Revisión (Edición) -->
            <div class="flex flex-col gap-4  border-2 bg-white border-gray-200 rounded-2xl p-4 w-2/3"
                *ngIf="mode === 'edit' || mode === 'view'">
                <span class="text-xl md:text-xl font-extrabold tracking-tight leading-7 sm:leading-10 truncate">
                    Observaciones de la revisión
                </span>
                <mat-form-field appearance="outline" class="form-field w-full">
                    <mat-label>Observaciones</mat-label>
                    <textarea matInput formControlName="observacionesRevision" rows="4"
                        [readonly]="mode !== 'edit'"></textarea>
                </mat-form-field>
            </div>
        </div>
    </form>
</div>