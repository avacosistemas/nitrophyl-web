<h1 mat-dialog-title>{{ isEditMode ? 'Editar' : 'Añadir' }} Insumo</h1>
<div mat-dialog-content class="relative">
  <div *ngIf="isLoading" class="absolute inset-0 bg-white bg-opacity-75 z-10 flex items-center justify-center">
    <mat-progress-spinner mode="indeterminate"></mat-progress-spinner>
  </div>

  <form [formGroup]="insumoForm" class="mat-form-without-wrapper">
    <mat-tab-group animationDuration="0ms">
      <mat-tab label="Datos del Insumo">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">

          <div class="col-span-1">
            <ng-container formArrayName="tipos">
              <div *ngFor="let nivel of nivelesTipoInsumo; let i = index">
                <mat-form-field appearance="outline" class="w-full" *ngIf="tiposFormArray.controls[i]">
                  <mat-label>Tipo Nivel {{ i + 1 }}</mat-label>
                  <mat-select [formControl]="tiposFormArray.controls[i]"
                    (selectionChange)="onTipoSeleccionado($event.value, i)" required [compareWith]="compareWithId">
                    <mat-option *ngFor="let tipo of nivel" [value]="tipo">
                      {{ tipo.nombre }}
                    </mat-option>
                  </mat-select>
                  <mat-error *ngIf="tiposFormArray.controls[i].hasError('required')">Requerido</mat-error>
                </mat-form-field>
              </div>
            </ng-container>
          </div>

          <div class="col-span-1 md:col-span-2">
            <mat-form-field appearance="outline" class="w-full">
              <mat-label>Insumo</mat-label>
              <input type="text" matInput formControlName="insumo" [matAutocomplete]="autoInsumo" required>
              <mat-autocomplete #autoInsumo="matAutocomplete" [displayWith]="displayFn">
                <mat-option *ngFor="let ins of filteredInsumos$ | async" [value]="ins">
                  {{ ins.nombre }}
                </mat-option>
              </mat-autocomplete>
              <mat-error *ngIf="insumoForm.get('insumo').hasError('required')">Insumo requerido</mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" class="w-full">
              <mat-label>Tratamiento</mat-label>
              <input type="text" matInput formControlName="tratamiento" [matAutocomplete]="autoTratamiento">
              <mat-autocomplete #autoTratamiento="matAutocomplete" [displayWith]="displayFn"
                (optionSelected)="onTratamientoSelected($event.option.value)">
                <mat-option *ngFor="let t of filteredTratamientos$ | async" [value]="t">
                  {{ t.nombre }}
                </mat-option>
              </mat-autocomplete>
              <mat-error>Tratamiento requerido</mat-error>
            </mat-form-field>

            <div class="grid grid-cols-2 gap-4">
              <mat-form-field appearance="outline" class="w-full">
                <mat-label>Medida (Valor)</mat-label>
                <input matInput formControlName="medidaValor">
              </mat-form-field>
              <mat-form-field appearance="outline" class="w-full">
                <mat-label>Medida (Obs.)</mat-label>
                <input matInput formControlName="medidaObservaciones">
              </mat-form-field>
            </div>

            <mat-form-field appearance="outline" class="w-full">
              <mat-label>Adhesivos</mat-label>
              <mat-chip-list #chipList aria-label="Selección de adhesivos">
                <mat-chip *ngFor="let adhesivo of adhesivosSeleccionados" (removed)="removeAdhesivo(adhesivo)">
                  {{adhesivo.nombre}}
                  <button matChipRemove>
                    <mat-icon>cancel</mat-icon>
                  </button>
                </mat-chip>
                <input placeholder="Buscar y añadir..." #adhesivoInput [formControl]="adhesivoCtrl"
                  [matAutocomplete]="autoAdhesivo" [matChipInputFor]="chipList">
              </mat-chip-list>
              <mat-autocomplete #autoAdhesivo="matAutocomplete" (optionSelected)="addAdhesivo($event)">
                <mat-option *ngFor="let a of filteredAdhesivos$ | async" [value]="a">
                  {{ a.nombre }}
                </mat-option>
              </mat-autocomplete>
            </mat-form-field>
          </div>
        </div>
      </mat-tab>
      <mat-tab label="Observaciones">
        <div class="p-4">
          <mat-form-field appearance="outline" class="w-full">
            <mat-label>Observaciones Generales</mat-label>
            <textarea matInput formControlName="observaciones" rows="8"></textarea>
          </mat-form-field>
        </div>
      </mat-tab>
    </mat-tab-group>
  </form>
</div>
<div mat-dialog-actions class="justify-end">
  <button mat-stroked-button (click)="onCancel()">Cancelar</button>
  <button mat-flat-button color="primary" class="mat-focus-indicator mat-flat-button mat-button-base mat-accent"
    (click)="onSave()" [disabled]="insumoForm.invalid || isLoading">
    Guardar
  </button>
</div>