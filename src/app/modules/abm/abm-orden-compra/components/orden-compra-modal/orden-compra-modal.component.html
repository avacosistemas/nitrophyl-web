<h1 mat-dialog-title>{{ title }}</h1>

<div mat-dialog-content class="relative min-w-80">
    <div *ngIf="isLoading" class="absolute inset-0 bg-white bg-opacity-75 z-20 flex items-center justify-center">
        <mat-progress-spinner mode="indeterminate" diameter="48"></mat-progress-spinner>
    </div>

    <form [formGroup]="form" class="flex flex-col gap-4 pt-2">
        <mat-form-field appearance="outline" class="w-full">
            <mat-label>Cliente</mat-label>
            <input type="text" placeholder="Buscar cliente..." matInput formControlName="cliente"
                [matAutocomplete]="autoCliente" required #clienteInput="matAutocompleteTrigger"> 

            <button *ngIf="form.get('cliente').value" matSuffix mat-icon-button aria-label="Clear"
                (click)="clearClientSelection(); $event.stopPropagation()">
                <mat-icon class="icon-size-5" svgIcon="heroicons_solid:x-circle"></mat-icon>
            </button>

            <mat-autocomplete #autoCliente="matAutocomplete" [displayWith]="displayFn">
                <mat-option *ngFor="let cliente of filteredClientes$ | async" [value]="cliente">
                    {{ cliente.codigo ? cliente.codigo + ' - ' : '' }}{{ cliente.nombre }}
                </mat-option>
            </mat-autocomplete>
            <mat-error *ngIf="form.get('cliente').hasError('required')">El cliente es requerido.</mat-error>
        </mat-form-field>

        <div class="flex gap-4">
            <mat-form-field appearance="outline" class="w-1/2">
                <mat-label>Fecha de Orden</mat-label>
                <input matInput [matDatepicker]="picker" formControlName="fecha" required>
                <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
                <mat-datepicker #picker></mat-datepicker>
                <mat-error *ngIf="form.get('fecha').hasError('required')">La fecha es requerida.</mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" class="w-1/2">
                <mat-label>Nro. Comprobante</mat-label>
                <input matInput formControlName="nroComprobante" required>
                <mat-error *ngIf="form.get('nroComprobante').hasError('required')">Requerido</mat-error>
            </mat-form-field>
        </div>

        <mat-form-field appearance="outline" class="w-full">
            <mat-label>Nro. Interno</mat-label>
            <input matInput formControlName="nroInterno" required>
            <mat-error *ngIf="form.get('nroInterno').hasError('required')">El Nro. Interno es requerido.</mat-error>
        </mat-form-field>

        <div class="flex flex-col w-full">
            <label class="mb-2 text-sm font-medium text-gray-700">Documento de Orden (Solo PDF)</label>

            <div class="relative border-2 border-dashed rounded-xl p-6 transition-all duration-200 flex flex-col items-center justify-center cursor-pointer"
                [ngClass]="{
                    'border-primary bg-primary/5': isDragging,
                    'border-gray-300 bg-gray-50 hover:bg-gray-100': !isDragging && !selectedFile,
                    'border-green-400 bg-green-50': selectedFile
                }" (click)="fileInput.click()" (dragover)="onDragOver($event)" (dragleave)="onDragLeave($event)"
                (drop)="onDrop($event)">

                <input type="file" #fileInput (change)="onFileSelected($event)" accept="application/pdf" hidden>

                <ng-container *ngIf="!selectedFile">
                    <mat-icon class="icon-size-10 text-gray-400 mb-2"
                        svgIcon="heroicons_outline:cloud-upload"></mat-icon>
                    <p class="text-sm text-gray-600">
                        <span class="font-semibold text-primary">Haz clic para subir</span> o arrastra un archivo aqu√≠
                    </p>
                    <p class="text-xs text-gray-400 mt-1">PDF</p>
                </ng-container>

                <ng-container *ngIf="selectedFile">
                    <div class="flex items-center w-full bg-white p-3 rounded-lg border border-green-200 shadow-sm">
                        <mat-icon class="text-red-500 mr-3">picture_as_pdf</mat-icon>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-gray-900 truncate">{{ selectedFile.name }}</p>
                            <p class="text-xs text-gray-500">{{ (selectedFile.size / 1024).toFixed(1) }} KB</p>
                        </div>
                        <button color="warn" (click)="removeFile(); $event.stopPropagation()">
                            <mat-icon svgIcon="heroicons_solid:trash"></mat-icon>
                        </button>
                    </div>
                </ng-container>
            </div>
        </div>

    </form>
</div>

<div mat-dialog-actions class="flex justify-end gap-2 p-4 border-t">
    <button mat-stroked-button (click)="onCancel()">Cancelar</button>
    <button class="mat-focus-indicator mat-flat-button mat-button-base mat-accent" mat-flat-button
        [disabled]="form.invalid || isLoading" (click)="onSave()">
        <span>{{ isEditMode ? 'Actualizar' : 'Guardar' }}</span>
    </button>
</div>