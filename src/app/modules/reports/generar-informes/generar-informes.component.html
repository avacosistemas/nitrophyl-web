<div class="flex flex-col w-full max-w-5xl p-6 mx-auto">
  <div class="grid border-2 bg-white border-gray-200 rounded-2xl p-8 shadow-sm">

    <form [formGroup]="informesForm" class="flex flex-col gap-4 mb-6">
      <mat-form-field appearance="outline" class="w-full">
        <mat-label>Cliente</mat-label>
        <input type="text" matInput [formControl]="clientFilterControl" [matAutocomplete]="autoCliente" #clientInput>
        <button mat-icon-button matSuffix *ngIf="clientFilterControl.value" (click)="clearClientInput()">
          <mat-icon>close</mat-icon>
        </button>
        <mat-autocomplete #autoCliente="matAutocomplete" [displayWith]="_displayClientName"
          (optionSelected)="onClientSelected($event)">
          <mat-option *ngFor="let client of filteredClients | async" [value]="client">
            {{ client.codigo ? client.codigo + ' - ' : '' }}{{ client.nombre }}
          </mat-option>
        </mat-autocomplete>
      </mat-form-field>

      <mat-form-field appearance="outline" class="w-full">
        <mat-label>AÃ±adir Lote al informe</mat-label>
        <input matInput placeholder="Buscar por nro de lote..." [formControl]="lotFilterControl"
          [matAutocomplete]="autoLote" #lotInput>
        <mat-icon matPrefix class="mr-2">search</mat-icon>
        <mat-autocomplete #autoLote="matAutocomplete" [displayWith]="_displayLotName"
          (optionSelected)="onLotSelected($event)">
          <mat-option *ngFor="let lote of filteredLots | async" [value]="lote">
            {{ lote.nombre }}
          </mat-option>
        </mat-autocomplete>
      </mat-form-field>
    </form>

    <div class="mb-6 border rounded-lg overflow-hidden" [hidden]="dataSource.data.length === 0">
      <table mat-table [dataSource]="dataSource" class="w-full">

        <ng-container matColumnDef="nroLote">
          <th mat-header-cell *matHeaderCellDef> Lote </th>
          <td mat-cell *matCellDef="let element"> {{element.nroLote}} </td>
        </ng-container>

        <ng-container matColumnDef="fecha">
          <th mat-header-cell *matHeaderCellDef> Fecha </th>
          <td mat-cell *matCellDef="let element"> {{element.fecha}} </td>
        </ng-container>

        <ng-container matColumnDef="grado">
          <th mat-header-cell *matHeaderCellDef> Grado </th>
          <td mat-cell *matCellDef="let element"> {{element.formulaSimple}} </td>
        </ng-container>

        <ng-container matColumnDef="material">
          <th mat-header-cell *matHeaderCellDef> Material </th>
          <td mat-cell *matCellDef="let element"> {{element.material}} </td>
        </ng-container>

        <ng-container matColumnDef="acciones">
          <th mat-header-cell *matHeaderCellDef class="w-12"> </th>
          <td mat-cell *matCellDef="let element">
            <button mat-icon-button color="warn" (click)="removeLot(element.id)">
              <mat-icon>delete_outline</mat-icon>
            </button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
      </table>

      <div class="p-4 text-center text-gray-500 bg-gray-50" *ngIf="dataSource.data.length === 0">
        No hay lotes seleccionados.
      </div>
    </div>

    <div [formGroup]="informesForm" class="mb-6">
      <mat-form-field appearance="outline" class="w-full">
        <mat-label>Observaciones generales del informe</mat-label>
        <textarea matInput formControlName="observacionesInforme" rows="3"></textarea>
      </mat-form-field>
    </div>

    <div *ngIf="showErrorAlert"
      class="relative bg-red-50 border border-red-200 text-sm text-red-800 rounded-lg p-4 mb-4 shadow-sm" role="alert">

      <div class="flex">
        <div class="shrink-0">
          <mat-icon class="text-red-500">error</mat-icon>
        </div>
        <div class="ml-3">
          <h3 class="text-sm font-bold">
            {{ errorMessage }}
          </h3>
          <div class="mt-2 text-sm text-red-700" *ngIf="errorList.length > 0">
            <ul class="list-disc space-y-1 pl-5">
              <li *ngFor="let err of errorList">
                {{ err }}
              </li>
            </ul>
          </div>
        </div>

        <button type="button" (click)="closeError()"
          class="ml-auto -mx-1.5 -my-1.5 bg-red-50 text-red-500 rounded-lg p-1.5 hover:bg-red-100 inline-flex h-8 w-8">
          <mat-icon style="font-size: 18px;">close</mat-icon>
        </button>
      </div>
    </div>

    <div class="flex justify-end gap-3">
      <button mat-stroked-button (click)="onVistaPreviaInforme()"
        [disabled]="dataSource.data.length === 0 || !informesForm.get('selectedClient').value">
        <mat-icon class="mr-2">visibility</mat-icon> Vista Previa
      </button>

      <button mat-flat-button color="accent" (click)="onEnviarInforme()"
        [disabled]="dataSource.data.length === 0 || !informesForm.get('selectedClient').value || isSending">
        <mat-icon class="mr-2">send</mat-icon>
        {{ isSending ? 'Enviando...' : 'Enviar Informe' }}
      </button>
    </div>

  </div>
</div>